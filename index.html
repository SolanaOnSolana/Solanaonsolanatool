<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS â€” Guardian Control Center</title>
  <meta name="description" content="$SOS Guardian Control Center â€” live on-chain insights." />

  <style>
    :root{
      --bg:#070711;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;

      --radius: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --max: 1120px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 15.5px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      overflow-x:hidden;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.14), transparent 55%),
        var(--bg);
      transform: translateZ(0);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 18px}

    /* top bar */
    .topbar{
      position: sticky; top:0; z-index:20;
      backdrop-filter: blur(14px);
      background: rgba(7,7,17,.62);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 0;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:220px}
    .brand img{
      width:40px; height:40px; object-fit:contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .bt{display:flex; flex-direction:column; line-height:1.05}
    .bt .t{font-weight:1000; letter-spacing:-.2px; font-size:16px}
    .bt .s{font-weight:800; color:var(--muted); font-size:12.5px}

    .tabs{display:flex; gap:10px; flex:1; justify-content:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-weight:900; font-size:13px;
      transition:.15s ease;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .pill.active{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .right{display:flex; align-items:center; gap:10px; min-width:260px; justify-content:flex-end; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:900; font-size:13px;
      transition:.15s ease;
      user-select:none;
      cursor:pointer;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn.grad{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
    }
    .btn[disabled]{opacity:.55; pointer-events:none}

    /* layout */
    main{padding:22px 0 42px}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .row{flex-wrap:wrap}
      .tabs{order:3; width:100%; justify-content:flex-start}
      .right{order:2; width:100%; justify-content:flex-start}
      .grid{grid-template-columns:1fr}
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{padding:20px}
    .h1{
      margin:0;
      font-weight:1000;
      letter-spacing:-1px;
      line-height:1.05;
      font-size: clamp(34px, 4.6vw, 56px);
    }
    .gradText{
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{margin-top:8px; color:rgba(255,255,255,.74); font-weight:750}

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top:16px;
    }
    @media (max-width:980px){ .kpiGrid{grid-template-columns: repeat(2,1fr)} }
    .kpi{
      padding:14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .kpi .k{color: rgba(255,255,255,.70); font-weight:850; font-size:12px; letter-spacing:.45px; text-transform:uppercase}
    .kpi .v{margin-top:8px; font-weight:1000; font-size:20px}
    .kpi .mini{margin-top:6px; font-weight:800; font-size:12px; color: rgba(255,255,255,.62)}

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-top:16px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:-.2px;
    }

    .table{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      overflow:hidden;
    }
    .tr{
      display:grid;
      grid-template-columns: 1.1fr .9fr .8fr;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      align-items:center;
    }
    .tr.head{
      border-top:0;
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.72);
      font-weight:900;
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .addr{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-weight:850;
      color: rgba(255,255,255,.86);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .muted{color: rgba(255,255,255,.70); font-weight:800}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .badge.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .badge.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}

    /* wallet */
    .field{margin-top:14px}
    label{display:block; font-weight:950; font-size:12.5px; letter-spacing:.35px; color: rgba(255,255,255,.80); margin-bottom:8px}
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:800;
      letter-spacing:.2px;
    }
    input:focus{
      border-color: rgba(0,209,255,.45);
      box-shadow: 0 0 0 3px rgba(0,209,255,.12);
    }
    .walletGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:520px){ .walletGrid{grid-template-columns:1fr} }

    .statusLine{
      margin-top:10px;
      color: rgba(255,255,255,.70);
      font-weight:800;
      min-height: 18px;
      font-size:13px;
    }
    footer{
      padding: 18px 0 34px;
      color: rgba(255,255,255,.45);
      font-weight:650;
      text-align:center;
      font-size:12px;
    }

    /* view switching */
    .view{display:none}
    .view.active{display:block}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand" aria-label="Home">
          <img id="brandLogo" src="logo.png" alt="$SOS" onerror="this.style.display='none'">
          <div class="bt">
            <div class="t">$SOS</div>
            <div class="s">Guardian Control Center</div>
          </div>
        </div>

        <div class="tabs" aria-label="Tabs">
          <div class="pill active" data-tab="overview">Overview</div>
          <div class="pill" data-tab="wallet">Wallet Verdict</div>
        </div>

        <div class="right">
          <button class="btn" id="btnRefresh">Refresh</button>
          <button class="btn grad" id="btnAuto">Auto: ON</button>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <!-- OVERVIEW -->
    <section id="view-overview" class="view active">
      <div class="card">
        <div class="inner">
          <h1 class="h1"><span class="gradText">Guardian</span> System</h1>
          <div class="sub">Live on-chain signal layer for $SOS.</div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="k">Guardian Strength</div>
              <div class="v" id="kStrength">â€”</div>
              <div class="mini" id="kStrengthMini">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">Supply</div>
              <div class="v" id="kSupply">â€”</div>
              <div class="mini" id="kDecimals">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">Top Concentration</div>
              <div class="v" id="kTop">â€”</div>
              <div class="mini" id="kTopMini">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">Whale Signal</div>
              <div class="v" id="kWhale">â€”</div>
              <div class="mini" id="kWhaleMini">â€”</div>
            </div>
          </div>

          <div class="sectionTitle">
            <h2>Whale Watch (Largest Accounts)</h2>
            <span class="badge" id="lastUpdate">â€”</span>
          </div>

          <div class="table" role="table" aria-label="Largest accounts">
            <div class="tr head" role="row">
              <div>Address</div><div>Holding</div><div>Tier</div>
            </div>
            <div id="largestRows"></div>
          </div>

          <div class="sectionTitle" style="margin-top:14px">
            <h2>Distribution Snapshot</h2>
            <span class="muted" id="distNote">Based on largest accounts</span>
          </div>

          <div class="kpiGrid" style="margin-top:12px">
            <div class="kpi">
              <div class="k">Shrimp</div>
              <div class="v" id="dShrimp">â€”</div>
              <div class="mini">0 â€“ 10k</div>
            </div>
            <div class="kpi">
              <div class="k">Fish</div>
              <div class="v" id="dFish">â€”</div>
              <div class="mini">10k â€“ 100k</div>
            </div>
            <div class="kpi">
              <div class="k">Dolphin</div>
              <div class="v" id="dDolphin">â€”</div>
              <div class="mini">100k â€“ 1M</div>
            </div>
            <div class="kpi">
              <div class="k">Whale</div>
              <div class="v" id="dWhale">â€”</div>
              <div class="mini">1M+</div>
            </div>
          </div>

          <div class="statusLine" id="overviewStatus"></div>
        </div>
      </div>
    </section>

    <!-- WALLET -->
    <section id="view-wallet" class="view">
      <div class="card">
        <div class="inner">
          <h1 class="h1"><span class="gradText">Wallet</span> Verdict</h1>
          <div class="sub">Paste a Solana wallet. We read public on-chain data only.</div>

          <div class="field">
            <label for="wallet">Solana Wallet Address</label>
            <input id="wallet" placeholder="Enter wallet addressâ€¦" autocomplete="off" spellcheck="false" />
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn grad" id="btnCheck">Run Verdict</button>
            <a class="btn" id="btnShare" href="#" target="_blank" rel="noreferrer"
               style="opacity:.55; pointer-events:none;">Share on X</a>
          </div>

          <div class="walletGrid">
            <div class="kpi">
              <div class="k">Verdict</div>
              <div class="v" id="wVerdict">â€”</div>
              <div class="mini" id="wVerdictMini">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">$SOS Holding</div>
              <div class="v" id="wHold">â€”</div>
              <div class="mini" id="wHoldMini">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">Guardian Level</div>
              <div class="v" id="wLevel">â€”</div>
              <div class="mini" id="wLevelMini">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">Status</div>
              <div class="v" id="wStatus">â€”</div>
              <div class="mini" id="wStatusMini">â€”</div>
            </div>
          </div>

          <div class="statusLine" id="walletStatus"></div>
        </div>
      </div>
    </section>

    <footer>Â© <span id="y"></span> $SOS</footer>
  </main>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const HELIUS_API_KEY = "bb447d37-3c9a-45b8-994a-163fb8a75592";

/* Replace this with your real $SOS mint when you have it */
const SOS_MINT = "a3W4qutoEJA4232T2gwZUfgYJTetr96pU4SJMwppump";

/* Robust RPC list: Helius first (your key), then public fallbacks */
const RPC_URLS = [
  `https://mainnet.helius-rpc.com/?api-key=${encodeURIComponent(HELIUS_API_KEY)}`,
  "https://api.mainnet-beta.solana.com",
  "https://rpc.ankr.com/solana",
  "https://solana.drpc.org"
];

/** =========================
 *  DOM helpers
 *  ========================= */
const $ = (id)=>document.getElementById(id);
$("y").textContent = new Date().getFullYear();

async function loadFirst(paths){
  for(const p of paths){
    const ok = await new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res(img);
      img.onerror = ()=>res(null);
      img.src = p;
    });
    if(ok) return ok.src;
  }
  return null;
}
(async ()=>{
  const src = await loadFirst(["logo.png","assets/logo.png"]);
  if(src){
    const el = $("brandLogo");
    el.src = src;
    el.style.display = "";
  }
})();

function fmt(n){
  if(n === null || n === undefined || Number.isNaN(n)) return "â€”";
  try { return new Intl.NumberFormat("en-US").format(n); } catch { return String(n); }
}
function pct(n){ return (Math.round(n*1000)/10).toFixed(1) + "%"; }
function shortAddr(a){
  if(!a) return "â€”";
  return a.slice(0,4) + "â€¦" + a.slice(-4);
}
function looksBase58(s){
  return typeof s === "string"
    && s.length >= 32
    && s.length <= 52
    && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
}

/** =========================
 *  Tabs
 *  ========================= */
document.querySelectorAll(".pill").forEach(p=>{
  p.addEventListener("click", ()=>{
    document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    const tab = p.getAttribute("data-tab");
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    $("view-" + tab).classList.add("active");
  });
});

/** =========================
 *  RPC (robust)
 *  ========================= */
let _rpcIndex = 0;

async function rpc(method, params){
  const body = JSON.stringify({ jsonrpc:"2.0", id:1, method, params });

  for(let attempt=0; attempt<RPC_URLS.length; attempt++){
    const url = RPC_URLS[_rpcIndex % RPC_URLS.length];
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 12000);

    try{
      const res = await fetch(url, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body,
        signal: controller.signal
      });
      clearTimeout(t);

      if(res.status === 429) throw new Error("Rate limited (429)");
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${txt}`.slice(0,160));
      }
      const j = await res.json();
      if(j.error) throw new Error(j.error.message || "RPC error");
      return j.result;
    }catch(e){
      clearTimeout(t);
      _rpcIndex++;
      if(attempt === RPC_URLS.length - 1) throw e;
    }
  }
}

/** =========================
 *  On-chain readers
 *  ========================= */
async function getTokenSupply(mint){
  const r = await rpc("getTokenSupply", [mint]);
  const ui = Number(r?.value?.uiAmount ?? 0);
  const decimals = Number(r?.value?.decimals ?? 0);
  const raw = r?.value?.amount ? BigInt(r.value.amount) : 0n;
  return { ui, decimals, raw };
}

async function getLargestAccounts(mint){
  const r = await rpc("getTokenLargestAccounts", [mint]);
  // entries: { address, amount, decimals, uiAmountString }
  return r?.value || [];
}

async function getSplBalance(owner, mint){
  const r = await rpc("getTokenAccountsByOwner", [
    owner,
    { mint },
    { encoding:"jsonParsed" }
  ]);
  const arr = r?.value || [];
  if(arr.length === 0) return 0;

  let total = 0;
  for(const it of arr){
    const ta = it?.account?.data?.parsed?.info?.tokenAmount;
    if(ta) total += Number(ta.uiAmount || 0);
  }
  return total;
}

/** =========================
 *  Guardian logic (bullish framing)
 *  ========================= */
function tierFromHolding(x){
  if(x >= 1_000_000) return {t:"WHALE", cls:"good"};
  if(x >= 100_000)   return {t:"DOLPHIN", cls:"badge"};
  if(x >= 10_000)    return {t:"FISH", cls:"badge"};
  if(x > 0)          return {t:"SHRIMP", cls:"badge"};
  return {t:"VOID", cls:"bad"};
}
function levelFromHolding(x){
  if(x >= 10_000_000) return "GUARDIAN";
  if(x >= 1_000_000)  return "PROTECTOR";
  if(x >= 100_000)    return "SENTINEL";
  if(x > 0)           return "WATCHER";
  return "UNBOUND";
}
function verdictFromHolding(x){
  if(x >= 1_000_000) return {v:"APPROVED", mini:"Diamond hands detected." , badge:"good"};
  if(x >= 100_000)   return {v:"APPROVED", mini:"Protected by the Guardian.", badge:"good"};
  if(x > 0)          return {v:"OBSERVED", mini:"Holding â€” stay steady.", badge:"warn"};
  return {v:"REJECTED", mini:"No $SOS detected.", badge:"bad"};
}

/* Guardian Strength Index:
   - based on concentration + whale stability signal
   - uses largest accounts share of supply as proxy
*/
function strengthIndex({top10Share, top20Share}){
  // More distributed (lower share) => stronger social base
  // We map to 0..100 with a simple curve.
  const conc = Math.min(0.95, Math.max(0.05, top20Share));
  const score = Math.round((1 - conc) * 120); // typical 10..90 range
  const clamped = Math.max(5, Math.min(95, score));

  if(clamped >= 80) return {label:"ASCENDING", mini:"Distribution looks strong.", badge:"good"};
  if(clamped >= 60) return {label:"STRONG", mini:"Guardian presence is firm.", badge:"good"};
  if(clamped >= 40) return {label:"STABLE", mini:"Holding line looks steady.", badge:"warn"};
  return {label:"WEAK", mini:"Concentration risk detected.", badge:"bad"};
}

/** =========================
 *  Overview refresh
 *  ========================= */
let lastLargestSnapshot = null; // for whale signal deltas

function setBadge(el, text, cls){
  el.textContent = text;
  el.classList.remove("good","warn","bad");
  if(cls) el.classList.add(cls);
}

function clearOverview(){
  $("overviewStatus").textContent = "";
  $("largestRows").innerHTML = "";
}

async function refreshOverview(){
  clearOverview();
  $("overviewStatus").textContent = "Refreshingâ€¦";

  try{
    const supply = await getTokenSupply(SOS_MINT);
    const largest = await getLargestAccounts(SOS_MINT);

    const totalUi = supply.ui || 0;
    const top10 = largest.slice(0,10);
    const top20 = largest.slice(0,20);

    const sumTop10 = top10.reduce((a,x)=>a + Number(x.uiAmountString || 0), 0);
    const sumTop20 = top20.reduce((a,x)=>a + Number(x.uiAmountString || 0), 0);

    const top10Share = totalUi > 0 ? (sumTop10 / totalUi) : 0;
    const top20Share = totalUi > 0 ? (sumTop20 / totalUi) : 0;

    // Guardian strength
    const s = strengthIndex({top10Share, top20Share});
    $("kStrength").textContent = s.label;
    $("kStrengthMini").textContent = s.mini;

    // Supply
    $("kSupply").textContent = fmt(Math.floor(totalUi));
    $("kDecimals").textContent = `Decimals: ${supply.decimals}`;

    // Concentration
    $("kTop").textContent = `Top10 ${pct(top10Share)}`;
    $("kTopMini").textContent = `Top20 ${pct(top20Share)}`;

    // Whale signal: compare top10 holdings change from last snapshot
    let whaleMini = "No prior snapshot.";
    let whaleLabel = "â€”";
    let whaleCls = "badge";

    if(lastLargestSnapshot){
      const prev = lastLargestSnapshot; // Map addr -> amount
      let deltaAbs = 0;
      for(const a of top10){
        const addr = a.address;
        const now = Number(a.uiAmountString || 0);
        const before = prev.get(addr) || 0;
        deltaAbs += Math.abs(now - before);
      }
      const deltaPct = totalUi > 0 ? (deltaAbs / totalUi) : 0;
      // thresholding
      if(deltaPct < 0.001){
        whaleLabel = "CALM";
        whaleMini = "Top holders barely moved.";
        whaleCls = "good";
      } else if(deltaPct < 0.005){
        whaleLabel = "ACTIVE";
        whaleMini = "Whales are repositioning.";
        whaleCls = "warn";
      } else {
        whaleLabel = "VOLATILE";
        whaleMini = "Large balance shifts detected.";
        whaleCls = "bad";
      }
    }
    $("kWhale").textContent = whaleLabel;
    $("kWhaleMini").textContent = whaleMini;

    // update snapshot map
    lastLargestSnapshot = new Map(largest.map(x=>[x.address, Number(x.uiAmountString || 0)]));

    // table rows
    const frag = document.createDocumentFragment();
    const show = largest.slice(0,12);
    let shrimp=0, fish=0, dolphin=0, whale=0;

    for(const it of show){
      const addr = it.address;
      const holding = Number(it.uiAmountString || 0);
      const tier = tierFromHolding(holding);
      if(holding >= 1_000_000) whale++;
      else if(holding >= 100_000) dolphin++;
      else if(holding >= 10_000) fish++;
      else if(holding > 0) shrimp++;

      const row = document.createElement("div");
      row.className = "tr";
      row.innerHTML = `
        <div class="addr" title="${addr}">${addr}</div>
        <div class="muted">${fmt(Math.floor(holding))} SOS</div>
        <div><span class="badge ${tier.cls === 'good' ? 'good' : (tier.t==='VOID'?'bad':'')}">${tier.t}</span></div>
      `;
      frag.appendChild(row);
    }
    $("largestRows").appendChild(frag);

    // distribution snapshot (largest accounts only)
    $("dShrimp").textContent  = fmt(shrimp);
    $("dFish").textContent    = fmt(fish);
    $("dDolphin").textContent = fmt(dolphin);
    $("dWhale").textContent   = fmt(whale);

    const now = new Date();
    setBadge($("lastUpdate"), now.toLocaleTimeString(), "badge");

    $("overviewStatus").textContent = `Live: ${s.label} â€¢ Top10 ${pct(top10Share)} â€¢ Top20 ${pct(top20Share)}`;

  }catch(e){
    console.error(e);
    $("overviewStatus").textContent = "RPC error: " + (e?.message || "unknown");
  }
}

/** =========================
 *  Wallet verdict
 *  ========================= */
function makeShareText({verdict, holding, level, status, walletShort}){
  return `ðŸ›¡ï¸ $SOS Guardian Verdict

Verdict: ${verdict}
Status: ${status}
Level: ${level}
Holding: ${fmt(Math.floor(holding))} SOS
Wallet: ${walletShort}

Guardian Control Center:
${location.href}`;
}

async function runVerdict(){
  const w = $("wallet").value.trim();
  $("walletStatus").textContent = "";
  $("btnShare").style.opacity = ".55";
  $("btnShare").style.pointerEvents = "none";

  if(!looksBase58(w)){
    $("walletStatus").textContent = "Invalid wallet address.";
    return;
  }

  try{
    $("walletStatus").textContent = "Scanningâ€¦";
    const holding = await getSplBalance(w, SOS_MINT);

    const verdict = verdictFromHolding(holding);
    const level = levelFromHolding(holding);
    const status = holding > 0 ? "PROTECTED" : "UNPROTECTED";

    $("wVerdict").textContent = verdict.v;
    $("wVerdictMini").textContent = verdict.mini;

    $("wHold").textContent = `${fmt(Math.floor(holding))} SOS`;
    $("wHoldMini").textContent = holding > 0 ? "Holding detected." : "No tokens found.";

    $("wLevel").textContent = level;
    $("wLevelMini").textContent = (level === "UNBOUND") ? "Earn status by holding." : "Guardian alignment confirmed.";

    $("wStatus").textContent = status;
    $("wStatusMini").textContent = status === "PROTECTED" ? "Guardian shield is active." : "No shield.";

    // share
    const text = makeShareText({
      verdict: verdict.v,
      holding,
      level,
      status,
      walletShort: shortAddr(w)
    });
    const u = new URL("https://x.com/intent/tweet");
    u.searchParams.set("text", text);
    $("btnShare").href = u.toString();
    $("btnShare").style.opacity = "1";
    $("btnShare").style.pointerEvents = "auto";

    $("walletStatus").textContent = `${verdict.v} â€¢ ${status} â€¢ ${fmt(Math.floor(holding))} SOS`;

  }catch(e){
    console.error(e);
    $("walletStatus").textContent = "RPC error: " + (e?.message || "unknown");
  }
}

$("btnCheck").addEventListener("click", runVerdict);
$("wallet").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runVerdict(); });

/** =========================
 *  Auto refresh
 *  ========================= */
let autoOn = true;
let timer = null;

function setAuto(on){
  autoOn = on;
  $("btnAuto").textContent = `Auto: ${on ? "ON" : "OFF"}`;
  $("btnAuto").classList.toggle("grad", on);
  if(timer){ clearInterval(timer); timer = null; }
  if(on){
    timer = setInterval(refreshOverview, 30000);
  }
}

$("btnAuto").addEventListener("click", ()=> setAuto(!autoOn));
$("btnRefresh").addEventListener("click", refreshOverview);

/** =========================
 *  Init
 *  ========================= */
setAuto(true);
refreshOverview();
</script>
</body>
</html>

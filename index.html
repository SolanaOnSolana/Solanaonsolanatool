<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS â€” Guardian DNA Scanner</title>
  <meta name="description" content="Guardian DNA Scanner â€” decode wallet behavior on-chain + $SOS alignment." />

  <style>
    :root{
      --bg:#070711;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;

      --radius: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --max: 1120px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 15.5px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      overflow-x:hidden;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.14), transparent 55%),
        var(--bg);
      transform: translateZ(0);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 18px}

    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(14px);
      background: rgba(7,7,17,.62);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 0;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 220px;
      user-select:none;
    }
    .brand img{
      width:40px; height:40px; object-fit:contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .bt{display:flex; flex-direction:column; line-height:1.05}
    .bt .t{font-weight:1000; letter-spacing:-.2px; font-size:16px}
    .bt .s{font-weight:850; color:var(--muted); font-size:12.5px}

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    @media (min-width: 980px){
      .actions{width:auto}
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:900;
      font-size:13px;
      transition: .15s ease;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn.grad{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn[disabled]{opacity:.55; pointer-events:none}

    main{padding:22px 0 42px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{padding:22px}

    .hero{
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-60px -40px;
      background: radial-gradient(900px 520px at 20% 30%, rgba(20,241,149,.16), transparent 60%),
                  radial-gradient(900px 520px at 80% 20%, rgba(0,209,255,.12), transparent 60%),
                  radial-gradient(900px 520px at 70% 80%, rgba(153,69,255,.14), transparent 60%);
      z-index:0;
      pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}

    .h1{
      margin:0;
      font-weight:1000;
      letter-spacing:-1px;
      line-height:1.05;
      font-size: clamp(36px, 4.8vw, 62px);
    }
    .gradText{
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{
      margin-top:10px;
      color: rgba(255,255,255,.76);
      font-weight:800;
      max-width: 860px;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .split{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:16px;
    }

    .field{margin-top:12px}
    label{
      display:block;
      font-weight:950;
      font-size:12.5px;
      letter-spacing:.35px;
      color: rgba(255,255,255,.80);
      margin-bottom:8px
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:850;
      letter-spacing:.2px;
    }
    input:focus{
      border-color: rgba(0,209,255,.45);
      box-shadow: 0 0 0 3px rgba(0,209,255,.12);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .kpiGrid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 520px){ .kpiGrid{grid-template-columns: 1fr} }

    .kpi{
      padding:14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .kpi .k{color: rgba(255,255,255,.70); font-weight:850; font-size:12px; letter-spacing:.45px; text-transform:uppercase}
    .kpi .v{margin-top:8px; font-weight:1000; font-size:20px}
    .kpi .mini{margin-top:6px; font-weight:800; font-size:12px; color: rgba(255,255,255,.62)}

    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .badge.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .badge.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}

    .dnaCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.12));
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .dnaCard::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(800px 420px at 15% 25%, rgba(20,241,149,.14), transparent 60%),
        radial-gradient(800px 420px at 85% 20%, rgba(0,209,255,.10), transparent 60%),
        radial-gradient(800px 420px at 70% 85%, rgba(153,69,255,.12), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .dnaCard > *{position:relative; z-index:1}

    .bigVerdict{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .bigVerdict .title{
      font-weight:1000;
      letter-spacing:-.5px;
      font-size:22px;
    }
    .mono{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-weight:850;
      color: rgba(255,255,255,.86);
    }

    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      border-radius:999px;
      transition: width .25s ease;
    }

    .statusLine{
      margin-top:10px;
      color: rgba(255,255,255,.70);
      font-weight:850;
      min-height: 18px;
      font-size:13px;
    }

    footer{
      padding: 18px 0 34px;
      color: rgba(255,255,255,.45);
      font-weight:650;
      text-align:center;
      font-size:12px;
    }

    .tiny{
      font-size:12px;
      color: rgba(255,255,255,.55);
      font-weight:700;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img id="brandLogo" src="logo.png" alt="$SOS" onerror="this.style.display='none'">
          <div class="bt">
            <div class="t">$SOS</div>
            <div class="s">Guardian DNA Scanner</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnDemo">Load Demo Wallet</button>
          <button class="btn" id="btnAuto">Auto: ON</button>
          <button class="btn grad" id="btnScan">Scan DNA</button>
          <a class="btn" id="btnShare" href="#" target="_blank" rel="noreferrer"
             style="opacity:.55; pointer-events:none;">Share on X</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="card hero">
      <div class="inner">
        <h1 class="h1"><span class="gradText">Decode</span> Wallet DNA</h1>
        <div class="sub">
          This scanner reads public on-chain behavior and classifies a walletâ€™s conviction.
          It outputs a GLOBAL DNA profile + a separate $SOS alignment verdict.
        </div>

        <div class="split">
          <div class="panel">
            <div class="field">
              <label for="wallet">Wallet Address</label>
              <input id="wallet" placeholder="Paste Solana walletâ€¦" autocomplete="off" spellcheck="false" />
            </div>

            <div class="field">
              <label for="helius">Helius API Key</label>
              <input id="helius" placeholder="Paste your Helius key hereâ€¦" autocomplete="off" spellcheck="false" />
              <div class="tiny">Tip: rotate your key if you posted it anywhere.</div>
            </div>

            <div class="field">
              <label for="mint">$SOS Mint (optional â€” set later)</label>
              <input id="mint" placeholder="Paste $SOS mint (or leave default test mint)â€¦" autocomplete="off" spellcheck="false" />
              <div class="tiny">Default is a temporary test mint. Replace when your real mint is ready.</div>
            </div>

            <div class="statusLine" id="status">â€”</div>
          </div>

          <div class="dnaCard">
            <div class="bigVerdict">
              <div>
                <div class="title" id="arch">â€”</div>
                <div class="tiny mono" id="walletShort">â€”</div>
              </div>
              <span class="badge" id="verdictBadge">â€”</span>
            </div>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="k">Conviction</div>
                <div class="v" id="sConv">â€”</div>
                <div class="mini" id="mConv">â€”</div>
                <div class="bar"><div id="bConv"></div></div>
              </div>
              <div class="kpi">
                <div class="k">Jeeter Risk</div>
                <div class="v" id="sJeet">â€”</div>
                <div class="mini" id="mJeet">â€”</div>
                <div class="bar"><div id="bJeet"></div></div>
              </div>
              <div class="kpi">
                <div class="k">Heat</div>
                <div class="v" id="sHeat">â€”</div>
                <div class="mini" id="mHeat">â€”</div>
                <div class="bar"><div id="bHeat"></div></div>
              </div>
              <div class="kpi">
                <div class="k">Discipline</div>
                <div class="v" id="sDisc">â€”</div>
                <div class="mini" id="mDisc">â€”</div>
                <div class="bar"><div id="bDisc"></div></div>
              </div>
              <div class="kpi">
                <div class="k">Token Diversity</div>
                <div class="v" id="sDiv">â€”</div>
                <div class="mini" id="mDiv">â€”</div>
                <div class="bar"><div id="bDiv"></div></div>
              </div>
              <div class="kpi">
                <div class="k">$SOS Alignment</div>
                <div class="v" id="sSOS">â€”</div>
                <div class="mini" id="mSOS">â€”</div>
                <div class="bar"><div id="bSOS"></div></div>
              </div>
            </div>

            <div class="statusLine" id="summary">â€”</div>
          </div>
        </div>
      </div>
    </section>

    <footer>Â© <span id="y"></span> $SOS</footer>
  </main>

<script>
/** ============ Defaults ============ */
const DEFAULT_TEST_MINT = "a3W4qutoEJA4232T2gwZUfgYJTetr96pU4SJMwppump";
const DEFAULT_DEMO_WALLET = "7Q5LrGxQ8x9pK2m8wB7u9zWQ9Vt2pG2o9m5o8Z7p1p3X"; // harmless placeholder format

const $ = (id)=>document.getElementById(id);
$("y").textContent = new Date().getFullYear();

/** logo load (root or /assets) */
(async ()=>{
  const el = $("brandLogo");
  const trySrc = async (src)=> new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(src);
    img.onerror = ()=>res(null);
    img.src = src;
  });
  const src = await trySrc("logo.png") || await trySrc("assets/logo.png");
  if(src){ el.src = src; el.style.display=""; } else { el.style.display="none"; }
})();

function looksBase58(s){
  return typeof s === "string"
    && s.length >= 32 && s.length <= 52
    && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
}
function shortAddr(a){ return a ? (a.slice(0,4)+"â€¦"+a.slice(-4)) : "â€”"; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function pctBar(el, val){ el.style.width = clamp(val,0,100) + "%"; }
function setBadge(el, txt, mode){
  el.textContent = txt;
  el.classList.remove("good","warn","bad");
  if(mode) el.classList.add(mode);
}

function fmt(n){
  if(n === null || n === undefined || Number.isNaN(n)) return "â€”";
  try { return new Intl.NumberFormat("en-US").format(n); } catch { return String(n); }
}

/** ============ Helius calls ============ */
async function heliusFetch(apiKey, path, params){
  const u = new URL(`https://api.helius.xyz${path}`);
  u.searchParams.set("api-key", apiKey);
  if(params){
    for(const [k,v] of Object.entries(params)){
      if(v !== undefined && v !== null) u.searchParams.set(k, String(v));
    }
  }
  const res = await fetch(u.toString(), { method:"GET" });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`Helius HTTP ${res.status} ${txt}`.slice(0,180));
  }
  return res.json();
}

/**
 * Enhanced transactions for a wallet (recent window).
 * Endpoint: /v0/addresses/{address}/transactions
 * Note: Helius supports this. Free tier usually allows limited volume.
 */
async function getRecentTx(apiKey, wallet, limit=120){
  return heliusFetch(apiKey, `/v0/addresses/${wallet}/transactions`, { limit });
}

/** Minimal RPC fallback list (only for token balance) */
function rpcUrls(apiKey){
  return [
    `https://mainnet.helius-rpc.com/?api-key=${encodeURIComponent(apiKey)}`,
    "https://api.mainnet-beta.solana.com",
    "https://rpc.ankr.com/solana",
    "https://solana.drpc.org"
  ];
}
let _rpcIndex = 0;
async function rpc(apiKey, method, params){
  const urls = rpcUrls(apiKey);
  const body = JSON.stringify({ jsonrpc:"2.0", id:1, method, params });

  for(let attempt=0; attempt<urls.length; attempt++){
    const url = urls[_rpcIndex % urls.length];
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 12000);

    try{
      const res = await fetch(url, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body,
        signal: controller.signal
      });
      clearTimeout(t);

      if(res.status === 429) throw new Error("Rate limited (429)");
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`RPC HTTP ${res.status} ${txt}`.slice(0,160));
      }
      const j = await res.json();
      if(j.error) throw new Error(j.error.message || "RPC error");
      return j.result;

    }catch(e){
      clearTimeout(t);
      _rpcIndex++;
      if(attempt === urls.length - 1) throw e;
    }
  }
}

async function getSplBalance(apiKey, owner, mint){
  const r = await rpc(apiKey, "getTokenAccountsByOwner", [
    owner,
    { mint },
    { encoding:"jsonParsed" }
  ]);
  const arr = r?.value || [];
  if(arr.length === 0) return 0;
  let total = 0;
  for(const it of arr){
    const ta = it?.account?.data?.parsed?.info?.tokenAmount;
    if(ta) total += Number(ta.uiAmount || 0);
  }
  return total;
}

/** ============ DNA Heuristics (Hype-grade) ============ */
/**
 * We extract high-signal features from recent enhanced tx:
 * - activity rate (tx count)
 * - swap ratio (presence of swap-like sources)
 * - diversity (unique token mints touched)
 * - hold discipline proxy (fewer quick in/out patterns)
 * - jeeter risk proxy (high swap ratio + high diversity + low discipline)
 *
 * This is intentionally "signal-first": it produces a fun, shareable classification.
 */
function analyzeDNA(txs){
  const N = txs.length || 0;
  if(N === 0){
    return {
      conviction: 10, jeeter: 90, heat: 5, discipline: 10, diversity: 5,
      archetype: "UNREADABLE PROFILE",
      verdict: {label:"OBSERVED", badge:"warn"},
      summary: "No readable recent activity window."
    };
  }

  // features
  let swapish = 0;
  let sources = new Map();
  let mints = new Set();
  let transferCount = 0;

  // A light â€œin/outâ€ proxy: count txs where both tokenTransfers in & out exist.
  // This indicates frequent rotation.
  let inOut = 0;

  for(const tx of txs){
    const src = (tx.source || "UNKNOWN").toString().toUpperCase();
    sources.set(src, (sources.get(src)||0) + 1);

    // many enhanced tx contain tokenTransfers array
    const tt = Array.isArray(tx.tokenTransfers) ? tx.tokenTransfers : [];
    if(tt.length) transferCount += tt.length;

    const hasIn = tt.some(t => t.toUserAccount);
    const hasOut = tt.some(t => t.fromUserAccount);
    if(hasIn && hasOut) inOut++;

    // collect mints touched
    for(const t of tt){
      if(t.mint) mints.add(t.mint);
    }

    // swapish sources
    if(src.includes("JUPITER") || src.includes("RAYDIUM") || src.includes("ORCA") || src.includes("METEORA") || src.includes("SWAP")){
      swapish++;
    }
  }

  const swapRatio = swapish / Math.max(1, N);
  const diversityRaw = mints.size;
  const inOutRatio = inOut / Math.max(1, N);

  // Scores (0..100)
  const heat = clamp(Math.round(N / 1.2), 0, 100);                 // more tx => hotter
  const diversity = clamp(Math.round(diversityRaw * 6), 0, 100);   // more mints => higher
  const discipline = clamp(Math.round((1 - inOutRatio) * 100), 0, 100); // fewer rotations => higher discipline

  // conviction: high discipline + lower swapiness + moderate diversity
  const conviction = clamp(
    Math.round((discipline * 0.55) + ((1 - swapRatio) * 100 * 0.25) + (Math.max(0, 60 - diversity) * 0.20)),
    0, 100
  );

  // jeeter risk: swapiness + inOut + high diversity
  const jeeter = clamp(
    Math.round((swapRatio * 100 * 0.45) + (inOutRatio * 100 * 0.35) + (diversity * 0.20)),
    0, 100
  );

  // Archetype selection (this is where the hype lives)
  let archetype = "CHAIN WALKER";
  if(conviction >= 78 && jeeter <= 35) archetype = "DIAMOND OPERATOR";
  else if(conviction >= 65 && diversity <= 35) archetype = "QUIET ACCUMULATOR";
  else if(jeeter >= 75 && diversity >= 60) archetype = "EXIT LIQUIDITY ENGINE";
  else if(jeeter >= 68 && heat >= 60) archetype = "SWAP ADDICT";
  else if(discipline >= 70 && heat <= 35) archetype = "SLEEPING WHALE";
  else if(heat >= 80 && diversity <= 40) archetype = "HUNT MODE";
  else if(diversity >= 70 && heat <= 55) archetype = "COIN NOMAD";
  else if(discipline <= 35 && inOutRatio >= 0.35) archetype = "PANIC ROTATOR";

  // Verdict framing
  let verdict = {label:"OBSERVED", badge:"warn"};
  if(conviction >= 75 && jeeter <= 45) verdict = {label:"APPROVED", badge:"good"};
  if(jeeter >= 80 && conviction <= 40) verdict = {label:"EXILED", badge:"bad"};

  // Summary line (share-worthy)
  const summary =
    `${archetype} â€¢ Conviction ${conviction}/100 â€¢ Jeeter Risk ${jeeter}/100 â€¢ Discipline ${discipline}/100 â€¢ Diversity ${diversityRaw} mints`;

  return { conviction, jeeter, heat, discipline, diversity, archetype, verdict, diversityRaw, summary };
}

/** $SOS alignment (separate; exact) */
function sosAlignment(holding){
  // alignment is intentionally nonlinear for hype
  if(holding <= 0) return {score: 0, label:"UNALIGNED", mini:"No $SOS detected.", badge:"bad", level:"UNBOUND"};
  if(holding >= 1_000_000) return {score: 98, label:"DIAMOND", mini:"Guardian-grade conviction.", badge:"good", level:"PROTECTOR"};
  if(holding >= 100_000)   return {score: 85, label:"PROTECTED", mini:"Aligned to the Guardian.", badge:"good", level:"SENTINEL"};
  if(holding >= 10_000)    return {score: 62, label:"WATCHING", mini:"Holding â€” strengthen position.", badge:"warn", level:"WATCHER"};
  return {score: 40, label:"FRINGE", mini:"Small position detected.", badge:"warn", level:"WATCHER"};
}

/** Share builder */
function buildShareText(wallet, dna, sos){
  const link = location.href;
  const w = shortAddr(wallet);

  const lines = [
    `ðŸ›¡ï¸ GUARDIAN DNA SCAN â€” $SOS`,
    ``,
    `Wallet: ${w}`,
    `Archetype: ${dna.archetype}`,
    `Verdict: ${dna.verdict.label}`,
    `Conviction: ${dna.conviction}/100`,
    `Jeeter Risk: ${dna.jeeter}/100`,
    `Discipline: ${dna.discipline}/100`,
    `Diversity: ${dna.diversityRaw} mints`,
    ``,
    `$SOS Alignment: ${sos.label} (${sos.score}/100)`,
    `Level: ${sos.level}`,
    ``,
    `Scan yours: ${link}`
  ];
  return lines.join("\n");
}

/** ============ UI wiring ============ */
let autoOn = true;
let timer = null;

function setAuto(on){
  autoOn = on;
  $("btnAuto").textContent = `Auto: ${on ? "ON" : "OFF"}`;
  $("btnAuto").classList.toggle("grad", on);
  if(timer){ clearInterval(timer); timer = null; }
  if(on){
    timer = setInterval(()=>{ scan(true); }, 45000);
  }
}

$("btnAuto").addEventListener("click", ()=> setAuto(!autoOn));
setAuto(true);

$("btnDemo").addEventListener("click", ()=>{
  $("wallet").value = DEFAULT_DEMO_WALLET;
  $("mint").value = DEFAULT_TEST_MINT;
  $("status").textContent = "Demo loaded. Paste your Helius key and run scan.";
});

$("btnScan").addEventListener("click", ()=> scan(false));
$("wallet").addEventListener("keydown", (e)=>{ if(e.key==="Enter") scan(false); });

function setShareEnabled(enabled, url){
  const a = $("btnShare");
  if(enabled){
    a.href = url;
    a.style.opacity = "1";
    a.style.pointerEvents = "auto";
  }else{
    a.href = "#";
    a.style.opacity = ".55";
    a.style.pointerEvents = "none";
  }
}

function putScore(idV, idM, idB, value, mini){
  $(idV).textContent = `${value}/100`;
  $(idM).textContent = mini;
  pctBar($(idB), value);
}

async function scan(silent){
  const wallet = $("wallet").value.trim();
  const key = $("helius").value.trim();
  const mint = ($("mint").value.trim() || DEFAULT_TEST_MINT);

  setShareEnabled(false);

  if(!looksBase58(wallet)){
    $("status").textContent = "Invalid wallet address.";
    return;
  }
  if(!key || key.length < 10){
    $("status").textContent = "Paste your Helius API key.";
    return;
  }
  if(!looksBase58(mint)){
    $("status").textContent = "Mint looks invalid (or leave empty).";
    return;
  }

  try{
    if(!silent) $("status").textContent = "Scanning on-chain DNAâ€¦";
    $("walletShort").textContent = shortAddr(wallet);

    // 1) Global DNA from recent enhanced tx
    const txs = await getRecentTx(key, wallet, 120);
    const dna = analyzeDNA(Array.isArray(txs) ? txs : []);

    // 2) SOS exact alignment
    const holding = await getSplBalance(key, wallet, mint);
    const sos = sosAlignment(holding);

    // UI: archetype + verdict
    $("arch").textContent = dna.archetype;
    setBadge($("verdictBadge"), dna.verdict.label, dna.verdict.badge);

    putScore("sConv","mConv","bConv", dna.conviction,
      dna.conviction >= 75 ? "High conviction profile." : (dna.conviction >= 55 ? "Mixed conviction." : "Low conviction pattern.")
    );
    putScore("sJeet","mJeet","bJeet", 100 - dna.jeeter,
      dna.jeeter <= 35 ? "Low jeeter tendency." : (dna.jeeter <= 60 ? "Watch behavior." : "High jeeter tendency.")
    );
    putScore("sHeat","mHeat","bHeat", dna.heat,
      dna.heat >= 75 ? "Very active on-chain." : (dna.heat >= 45 ? "Active wallet." : "Low activity.")
    );
    putScore("sDisc","mDisc","bDisc", dna.discipline,
      dna.discipline >= 70 ? "Strong discipline." : (dna.discipline >= 45 ? "Some rotation." : "Frequent flip behavior.")
    );
    putScore("sDiv","mDiv","bDiv", dna.diversity,
      dna.diversityRaw >= 12 ? "Touches many tokens." : (dna.diversityRaw >= 6 ? "Diversified." : "Focused wallet.")
    );

    // SOS alignment score
    $("sSOS").textContent = `${sos.score}/100`;
    $("mSOS").textContent = `${sos.label} â€¢ ${sos.mini}`;
    pctBar($("bSOS"), sos.score);

    $("summary").textContent = dna.summary + ` â€¢ $SOS holding ${fmt(Math.floor(holding))}`;

    // Share
    const text = buildShareText(wallet, dna, sos);
    const u = new URL("https://x.com/intent/tweet");
    u.searchParams.set("text", text);
    setShareEnabled(true, u.toString());

    $("status").textContent = `Scan complete: ${dna.verdict.label} â€¢ ${dna.archetype} â€¢ $SOS ${sos.label}`;

  }catch(e){
    console.error(e);
    $("status").textContent = "Error: " + (e?.message || "unknown");
  }
}
</script>
</body>
</html>

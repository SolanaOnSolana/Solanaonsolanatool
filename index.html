<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS â€” Guardian Card</title>
  <meta name="description" content="Generate your $SOS Guardian Card from a Solana wallet." />

  <style>
    :root{
      --bg:#070711;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;
      --radius: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --stroke: rgba(255,255,255,.12);
      --panel: rgba(255,255,255,.06);
      --max: 980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      overflow-x:hidden;
      position: relative;
    }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.14), transparent 55%),
        var(--bg);
      transform: translateZ(0);
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:0 18px}
    .topbar{
      padding:18px 0 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      user-select:none;
    }
    .brand img{
      width:42px; height:42px; object-fit:contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .brand .t{font-weight:1000; letter-spacing:-.4px; font-size:18px; line-height:1.1}
    .brand .s{font-weight:800; color:var(--muted); font-size:13px; line-height:1.1}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{padding:22px}

    .h1{
      margin:0;
      font-weight:1000;
      letter-spacing:-1px;
      line-height:1.1;
      font-size: clamp(34px, 4.5vw, 54px);
    }
    .grad{
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{
      margin-top:8px;
      color: rgba(255,255,255,.74);
      font-weight:750;
    }

    .field{margin-top:16px}
    label{
      display:block;
      font-weight:900;
      color: rgba(255,255,255,.82);
      font-size:13px;
      letter-spacing:.3px;
      margin-bottom:8px;
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:750;
      letter-spacing:.2px;
    }
    input:focus{
      border-color: rgba(0,209,255,.45);
      box-shadow: 0 0 0 3px rgba(0,209,255,.12)
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:900;
      font-size:13px;
      transition: .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn.primary{
      border: 0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color: #061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn[disabled]{opacity:.55; pointer-events:none}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:18px;
    }

    canvas{
      width:100%;
      height:auto;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
    }

    .tiny{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.55);
      font-weight:650;
    }

    footer{
      padding: 18px 0 34px;
      color: rgba(255,255,255,.45);
      font-weight:650;
      text-align:center;
      font-size:12px;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="assets/logo.png" alt="$SOS" onerror="this.style.display='none'">
        <div>
          <div class="t">$SOS</div>
          <div class="s">Guardian Card Generator</div>
        </div>
      </div>
    </div>

    <section class="card">
      <div class="inner">
        <h1 class="h1"><span class="grad">Generate</span> your Guardian Card</h1>
        <div class="sub">Paste your Solana wallet address to mint your personalized card.</div>

        <div class="field">
          <label for="wallet">Solana Wallet Address</label>
          <input id="wallet" placeholder="Enter wallet addressâ€¦" autocomplete="off" spellcheck="false" />
        </div>

        <div class="row">
          <button class="btn primary" id="btnGenerate">Generate</button>
          <button class="btn" id="btnDownload" disabled>Download PNG</button>
          <a class="btn" id="btnShare" href="#" target="_blank" rel="noreferrer" style="opacity:.55; pointer-events:none;">Share on X</a>
        </div>

        <div class="grid">
          <canvas id="card" width="1200" height="1680" aria-label="Guardian Card Preview"></canvas>
        </div>

        <div class="tiny" id="statusLine"></div>
      </div>
    </section>

    <footer>Â© <span id="y"></span> $SOS</footer>
  </main>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
// Test mint you provided:
const SOS_MINT = "a3W4qutoEJA4232T2gwZUfgYJTetr96pU4SJMwppump";

// You can keep public RPC for now; if you ever get rate-limited, swap to a provider URL.
const RPC_URLS = [
  "https://api.mainnet-beta.solana.com",
  "https://rpc.ankr.com/solana",
  "https://solana.drpc.org",
];


/** =========================
 *  Helpers
 *  ========================= */
const $ = (id) => document.getElementById(id);
$("y").textContent = new Date().getFullYear();

function looksLikeBase58(s){
  return typeof s === "string"
    && s.length >= 32
    && s.length <= 52
    && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
}
function shortWallet(w){ return w ? (w.slice(0,4) + "â€¦" + w.slice(-4)) : "â€”"; }
function formatNumber(n){
  try { return new Intl.NumberFormat("en-US").format(n); }
  catch { return String(n); }
}

async function rpc(method, params){
  const res = await fetch(RPC_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
  });
  const j = await res.json().catch(()=>null);
  if(!res.ok) throw new Error("RPC HTTP " + res.status);
  if(!j) throw new Error("RPC parse error");
  if(j.error) throw new Error(j.error.message || "RPC error");
  return j.result;
}

let _rpcIndex = 0;

async function rpc(method, params){
  const body = JSON.stringify({ jsonrpc:"2.0", id:1, method, params });

  for(let attempt = 0; attempt < RPC_URLS.length; attempt++){
    const url = RPC_URLS[_rpcIndex % RPC_URLS.length];

    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    try{
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body,
        signal: controller.signal
      });

      clearTimeout(t);

      if(res.status === 429) throw new Error("Rate limited (429)");

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${txt}`.slice(0,180));
      }

      const j = await res.json();
      if(j.error) throw new Error(j.error.message || "RPC error");
      return j.result;

    } catch(e){
      clearTimeout(t);
      _rpcIndex++;
      if(attempt === RPC_URLS.length - 1) throw e;
    }
  }
}


  const value = result?.value || [];
  if(value.length === 0) return 0;

  let totalUi = 0;
  for(const acc of value){
    const info = acc?.account?.data?.parsed?.info;
    const tokenAmount = info?.tokenAmount;
    if(tokenAmount) totalUi += Number(tokenAmount.uiAmount || 0);
  }
  return totalUi;
}

/** =========================
 *  Assets
 *  ========================= */
async function loadImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>resolve(null);
    img.src = src;
  });
}

let logoImg = null;
let artImg  = null;

(async ()=>{
  logoImg = await loadImage("assets/logo.png");
  artImg  = await loadImage("assets/sticker.png"); // optional
  drawCard({
    wallet: "â€”",
    balance: 0,
    status: "UNPROTECTED",
    rarity: "BROKEN",
    level: "UNBOUND",
    power: 66,
    timestamp: new Date()
  });
})();

/** =========================
 *  Rarity + Level
 *  ========================= */
function rarityFromHolding(balance){
  if(balance <= 0) return "BROKEN";
  if(balance >= 1_000_000) return "DIAMOND HOLO";
  if(balance >= 100_000) return "HOLO";
  return "STANDARD";
}
function guardianLevel(balance){
  if(balance >= 10_000_000) return "GUARDIAN";
  if(balance >= 1_000_000)  return "PROTECTOR";
  if(balance >= 100_000)    return "SENTINEL";
  if(balance > 0)           return "WATCHER";
  return "UNBOUND";
}
function powerFromHolding(balance){
  // deterministic, feels like a stat scale
  if(balance <= 0) return 12;
  const p = Math.floor(Math.log10(balance + 1) * 85 + 40);
  return Math.max(20, Math.min(180, p));
}

/** =========================
 *  Canvas: TCG / PokÃ©mon-inspired (own style)
 *  ========================= */
function rr(ctx,x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}

function holoOverlay(ctx, x, y, w, h, intensity=0.25){
  ctx.save();
  ctx.globalAlpha = intensity;

  // diagonal shimmer gradient
  const g = ctx.createLinearGradient(x, y+h, x+w, y);
  g.addColorStop(0, "rgba(20,241,149,.00)");
  g.addColorStop(0.2, "rgba(20,241,149,.25)");
  g.addColorStop(0.5, "rgba(0,209,255,.22)");
  g.addColorStop(0.8, "rgba(153,69,255,.25)");
  g.addColorStop(1, "rgba(153,69,255,.00)");
  ctx.fillStyle = g;
  ctx.fillRect(x,y,w,h);

  // subtle dot pattern
  ctx.globalAlpha = intensity * 0.55;
  ctx.fillStyle = "rgba(255,255,255,.18)";
  for(let yy=y; yy<y+h; yy+=18){
    for(let xx=x; xx<x+w; xx+=18){
      if(((xx+yy)/18|0)%3===0) ctx.fillRect(xx,yy,2,2);
    }
  }

  ctx.restore();
}

function crackOverlay(ctx, x, y, w, h){
  ctx.save();
  ctx.globalAlpha = 0.55;
  ctx.strokeStyle = "rgba(0,0,0,.55)";
  ctx.lineWidth = 6;

  const lines = [
    [[x+w*0.15,y+h*0.20],[x+w*0.40,y+h*0.35],[x+w*0.25,y+h*0.62],[x+w*0.52,y+h*0.80]],
    [[x+w*0.70,y+h*0.10],[x+w*0.55,y+h*0.28],[x+w*0.78,y+h*0.44],[x+w*0.62,y+h*0.66],[x+w*0.88,y+h*0.86]],
    [[x+w*0.08,y+h*0.88],[x+w*0.30,y+h*0.72],[x+w*0.18,y+h*0.52]]
  ];
  for(const seg of lines){
    ctx.beginPath();
    ctx.moveTo(seg[0][0], seg[0][1]);
    for(let i=1;i<seg.length;i++) ctx.lineTo(seg[i][0], seg[i][1]);
    ctx.stroke();
  }

  // grime vignette
  const vg = ctx.createRadialGradient(x+w*0.5,y+h*0.55, w*0.1, x+w*0.5,y+h*0.55, w*0.75);
  vg.addColorStop(0, "rgba(0,0,0,0)");
  vg.addColorStop(1, "rgba(0,0,0,.55)");
  ctx.globalAlpha = 0.35;
  ctx.fillStyle = vg;
  ctx.fillRect(x,y,w,h);

  ctx.restore();
}

function drawCard(data){
  const c = $("card");
  const ctx = c.getContext("2d");
  const W = c.width, H = c.height;

  ctx.clearRect(0,0,W,H);

  // background
  ctx.fillStyle = "#070711";
  ctx.fillRect(0,0,W,H);

  // outer frame based on rarity
  const pad = 60;
  const fx = pad, fy = pad, fw = W-pad*2, fh = H-pad*2;

  let frameGrad = ctx.createLinearGradient(fx, fy, fx+fw, fy);
  if(data.rarity === "BROKEN"){
    frameGrad.addColorStop(0, "rgba(255,255,255,.18)");
    frameGrad.addColorStop(1, "rgba(255,255,255,.10)");
  } else if(data.rarity === "STANDARD"){
    frameGrad.addColorStop(0, "#14F195");
    frameGrad.addColorStop(0.5, "#00D1FF");
    frameGrad.addColorStop(1, "#9945FF");
  } else if(data.rarity === "HOLO"){
    frameGrad.addColorStop(0, "#00D1FF");
    frameGrad.addColorStop(0.5, "#14F195");
    frameGrad.addColorStop(1, "#9945FF");
  } else { // DIAMOND HOLO
    frameGrad.addColorStop(0, "#14F195");
    frameGrad.addColorStop(0.25, "#00D1FF");
    frameGrad.addColorStop(0.5, "#ffffff");
    frameGrad.addColorStop(0.75, "#00D1FF");
    frameGrad.addColorStop(1, "#9945FF");
  }

  rr(ctx, fx, fy, fw, fh, 54);
  ctx.lineWidth = 18;
  ctx.strokeStyle = frameGrad;
  ctx.stroke();

  // inner panel
  const ip = 22;
  const ix = fx+ip, iy = fy+ip, iw = fw-ip*2, ih = fh-ip*2;
  rr(ctx, ix, iy, iw, ih, 44);
  ctx.fillStyle = "rgba(255,255,255,.06)";
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.stroke();

  // HEADER (name + HP-like stat)
  const hx = ix+26, hy = iy+26, hw = iw-52, hh = 128;
  rr(ctx, hx, hy, hw, hh, 30);
  ctx.fillStyle = "rgba(0,0,0,.22)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.stroke();

  ctx.font = "1000 56px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.92)";
  ctx.fillText("SOLANA", hx+26, hy+80);

  // right stat (POWER)
  ctx.font = "950 34px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.78)";
  const statText = String(data.power) + " SOL";
  const m = ctx.measureText(statText).width;
  ctx.fillText(statText, hx+hw-m-64, hy+54);

  // small symbol (logo)
  if(logoImg){
    const s = 54;
    const lx = hx+hw-26-s;
    const ly = hy+hh-26-s;
    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.drawImage(logoImg, lx, ly, s, s);
    ctx.restore();
  } else {
    // fallback circle symbol
    ctx.save();
    ctx.globalAlpha = 0.7;
    ctx.fillStyle = "rgba(255,255,255,.18)";
    ctx.beginPath();
    ctx.arc(hx+hw-52, hy+hh-52, 22, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  // type line
  ctx.font = "850 20px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.70)";
  const typeLine = `GENESIS  â€¢  Solana On Solana  â€¢  ${data.rarity}`;
  ctx.fillText(typeLine, hx+26, hy+118);

  // ART BOX
  const ax = ix+26, ay = hy+hh+20, aw = iw-52, ah = 850;
  rr(ctx, ax, ay, aw, ah, 40);
  ctx.fillStyle = "rgba(0,0,0,.24)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.stroke();

  // art background glow
  ctx.save();
  const ag = ctx.createRadialGradient(ax+aw*0.6, ay+ah*0.35, 20, ax+aw*0.6, ay+ah*0.35, aw*0.85);
  if(data.status === "PROTECTED"){
    ag.addColorStop(0, "rgba(20,241,149,.28)");
    ag.addColorStop(0.55, "rgba(0,209,255,.14)");
  } else {
    ag.addColorStop(0, "rgba(255,80,120,.22)");
    ag.addColorStop(0.55, "rgba(153,69,255,.12)");
  }
  ag.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = ag;
  ctx.fillRect(ax, ay, aw, ah);
  ctx.restore();

  // watermark logo large
  if(logoImg){
    ctx.save();
    ctx.globalAlpha = 0.09;
    const scale = Math.min(aw/(logoImg.width*1.1), ah/(logoImg.height*1.1));
    const lw = logoImg.width*scale, lh = logoImg.height*scale;
    ctx.drawImage(logoImg, ax+(aw-lw)/2, ay+(ah-lh)/2 - 30, lw, lh);
    ctx.restore();
  }

  // main art: sticker.png if available, else placeholder silhouette
  if(artImg){
    ctx.save();
    ctx.globalAlpha = 0.98;
    // fit art nicely inside, left-biased like a character
    const maxW = aw*0.62;
    const maxH = ah*0.78;
    const s = Math.min(maxW/artImg.width, maxH/artImg.height);
    const w = artImg.width*s, h = artImg.height*s;
    const px = ax + aw*0.10;
    const py = ay + ah*0.12;
    ctx.drawImage(artImg, px, py, w, h);
    ctx.restore();
  } else {
    // placeholder silhouette
    ctx.save();
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "rgba(255,255,255,.75)";
    rr(ctx, ax+aw*0.12, ay+ah*0.18, aw*0.32, ah*0.60, 70);
    ctx.fill();
    ctx.restore();
  }

  // HOLO overlay on art box
  if(data.rarity === "HOLO") holoOverlay(ctx, ax, ay, aw, ah, 0.22);
  if(data.rarity === "DIAMOND HOLO") holoOverlay(ctx, ax, ay, aw, ah, 0.32);

  // BROKEN overlay
  if(data.rarity === "BROKEN") crackOverlay(ctx, ax, ay, aw, ah);

  // ABILITY BOX
  const bx = ax, by = ay+ah+20, bw = aw, bh = 92;
  rr(ctx, bx, by, bw, bh, 28);
  ctx.fillStyle = "rgba(0,0,0,.22)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.stroke();

  ctx.font = "950 28px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.90)";
  ctx.fillText("Ability  â–²  Proof of Protection", bx+24, by+58);

  // STATS PANEL
  const sx = ix+26, sy = by+bh+16, sw = iw-52, sh = ih - (sy-iy) - 26;
  rr(ctx, sx, sy, sw, sh, 36);
  ctx.fillStyle = "rgba(0,0,0,.20)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.stroke();

  // Left labels
  ctx.font = "850 22px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.72)";
  const lX = sx+26, lY = sy+54, gap=64;
  ctx.fillText("Status", lX, lY);
  ctx.fillText("Holding", lX, lY+gap);
  ctx.fillText("Guardian Level", lX, lY+gap*2);
  ctx.fillText("Wallet", lX, lY+gap*3);

  // values
  ctx.font = "1000 26px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.92)";
  ctx.fillText(data.status, lX+210, lY);
  ctx.fillText(`${formatNumber(Math.floor(data.balance))} SOS`, lX+210, lY+gap);
  ctx.fillText(data.level, lX+210, lY+gap*2);
  ctx.fillText(shortWallet(data.wallet), lX+210, lY+gap*3);

  // PokÃ©mon-like bottom line: weakness / resistance / retreat
  const bottomY = sy+sh-54;
  ctx.save();
  ctx.globalAlpha = 0.85;
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(sx+26, bottomY);
  ctx.lineTo(sx+sw-26, bottomY);
  ctx.stroke();
  ctx.restore();

  ctx.font = "900 18px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.70)";
  ctx.fillText("Weakness", sx+26, bottomY+32);
  ctx.fillText("Resistance", sx+sw*0.40, bottomY+32);
  ctx.fillText("Retreat", sx+sw*0.72, bottomY+32);

  // values (meme-ish but consistent)
  ctx.font = "1000 20px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.90)";
  ctx.fillText(data.status === "PROTECTED" ? "FUD Ã—2" : "FUD Ã—4", sx+26, bottomY+56);
  ctx.fillText(data.rarity.includes("HOLO") ? "LATENCY -20" : "LATENCY 0", sx+sw*0.40, bottomY+56);
  ctx.fillText(data.level === "UNBOUND" ? "â˜…â˜…â˜…" : "â˜…", sx+sw*0.72, bottomY+56);

  // footer tiny set line
  const ts = new Date(data.timestamp || Date.now()).toISOString().replace("T"," ").slice(0,19) + " UTC";
  ctx.font = "800 16px ui-sans-serif, system-ui, Segoe UI, Arial";
  ctx.fillStyle = "rgba(255,255,255,.55)";
  ctx.fillText(`SET: SOS-GENESIS â€¢ ${ts}`, sx+26, sy+sh-18);

  // slight overall holo on whole card for diamond
  if(data.rarity === "DIAMOND HOLO"){
    holoOverlay(ctx, ix, iy, iw, ih, 0.10);
  }
}

/** =========================
 *  Actions
 *  ========================= */
function setReady(ready){
  $("btnDownload").disabled = !ready;
  const share = $("btnShare");
  if(ready){
    share.style.opacity = "1";
    share.style.pointerEvents = "auto";
  } else {
    share.style.opacity = ".55";
    share.style.pointerEvents = "none";
  }
}

function makeShareUrl({walletShort, balance, status, rarity, level}){
  const base = window.location.href;
  const text =
`ðŸƒ $SOS Guardian Card
Status: ${status} â€¢ ${rarity}
Level: ${level}
Holding: ${formatNumber(Math.floor(balance))} SOS
Wallet: ${walletShort}

Generate yours: ${base}`;
  const u = new URL("https://x.com/intent/tweet");
  u.searchParams.set("text", text);
  return u.toString();
}

async function generate(){
  const w = $("wallet").value.trim();
  $("statusLine").textContent = "";
  setReady(false);

  if(!looksLikeBase58(w)){
    $("statusLine").textContent = "Invalid wallet address.";
    return;
  }

  try{
    $("statusLine").textContent = "Generatingâ€¦";
    const bal = await getSplBalance(w, SOS_MINT);

    const status = bal > 0 ? "PROTECTED" : "UNPROTECTED";
    const rarity = rarityFromHolding(bal);
    const level  = guardianLevel(bal);
    const power  = powerFromHolding(bal);

    drawCard({
      wallet: w,
      balance: bal,
      status,
      rarity,
      level,
      power,
      timestamp: new Date()
    });

    $("btnShare").href = makeShareUrl({
      walletShort: shortWallet(w),
      balance: bal,
      status,
      rarity,
      level
    });

    $("statusLine").textContent = `${status} â€¢ ${rarity} â€¢ ${formatNumber(Math.floor(bal))} SOS`;
    setReady(true);
  } catch(e){
    console.error(e);
    $("statusLine").textContent = "$("statusLine").textContent = "RPC error: " + (e?.message || "unknown");

  }
}

$("btnGenerate").addEventListener("click", generate);
$("wallet").addEventListener("keydown", (e)=>{ if(e.key==="Enter") generate(); });

$("btnDownload").addEventListener("click", ()=>{
  const c = $("card");
  c.toBlob((blob)=>{
    if(!blob) return;
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = "sos-guardian-card.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }, "image/png");
});
</script>
</body>
</html>
